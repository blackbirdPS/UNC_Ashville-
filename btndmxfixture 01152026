on DMXGridComplete pWhichGrid
   global stdstckname, theNode
   global gDMXRAMCache
   global iconOn, iconOff
   
   local tParentGroup, tBaseByte
   local tGroups, tGridName, tGridIndex
   local tDGData, tKeys, tRow
   local tMinChan, tMaxChan
   local tStartByte, tCount
   local LhiByte, LlowByte, Lparameters, LrawBytes
   local tChan, tAddr, tRaw, tPercent
   
   put the owner of me into tParentGroup
   
   -- Base RAM byte
   put fld "DMXRAMStartByte" of cd "Settings" of stack stdstckname into tBaseByte
   if tBaseByte is not a number then put 1520 into tBaseByte
   
   put empty into tMinChan
   put empty into tMaxChan
   
   ----------------------------------------------------------------
   -- 1) FIND ALL DMX GRIDS + CHANNEL RANGE
   ----------------------------------------------------------------
   put the childControlNames of tParentGroup into tGroups
   filter tGroups with "DMXoutDataGrid*"
   
   repeat for each line tGridName in tGroups
      put the dgData of group tGridName of tParentGroup into tDGData
      put keys(tDGData) into tKeys
      
      repeat for each line tRow in tKeys
         put tDGData[tRow]["ChannelNumber"] into tChan
         if tChan is not a number then next repeat
         
         if tMinChan is empty or tChan < tMinChan then put tChan into tMinChan
         if tMaxChan is empty or tChan > tMaxChan then put tChan into tMaxChan
      end repeat
   end repeat
   
   if tMinChan is empty then exit DMXGridComplete
   
   ----------------------------------------------------------------
   -- 2) READ ONLY REQUIRED HARDWARE BYTES
   ----------------------------------------------------------------
   put tBaseByte + tMinChan - 1 into tStartByte
   put tMaxChan - tMinChan + 1 into tCount
   
   put tStartByte div 256 into LhiByte
   put tStartByte mod 256 into LlowByte
   put LhiByte & comma & LlowByte & comma & tCount into Lparameters
   
   start using stack stdstckname
   set the label of btn "theNode" of group "Menubuttons" of stack stdstckname to theNode
   put QuickAsk2(25, Lparameters) into LrawBytes
   stop using stack stdstckname
   
   -- Cache bytes
   repeat with i = 1 to tCount
      put item i of LrawBytes into gDMXRAMCache[tMinChan + i - 1]
   end repeat
   
   ----------------------------------------------------------------
   -- 3) UPDATE ALL GRIDS FROM CACHE
   ----------------------------------------------------------------
   repeat for each line tGridName in tGroups
      -- Extract grid index from name (DMXoutDataGrid = 1, DMXoutDataGrid2 = 2, etc.)
      put char 15 to -1 of tGridName into tGridIndex
      if tGridIndex is empty then put 1 into tGridIndex
      
      -- Skip if we're only updating a specific grid
      if pWhichGrid is not empty and pWhichGrid <> tGridIndex then next repeat
      
      put the dgData of group tGridName of tParentGroup into tDGData
      put keys(tDGData) into tKeys
      sort lines of tKeys numeric
      
      repeat for each line tRow in tKeys
         put tDGData[tRow]["ChannelNumber"] into tChan
         if tChan is not a number then next repeat
         
         -- Get value from cache using channel number
         put gDMXRAMCache[tChan] into tRaw
         
         if tRaw is an integer then
            put tRaw into tDGData[tRow]["ChannelLevel"]
            put statround((tRaw / 255) * 100) & "%" into tPercent
            put tPercent into tDGData[tRow]["ChannelPercent"]
         else
            put "!" into tDGData[tRow]["ChannelLevel"]
            put "!" into tDGData[tRow]["ChannelPercent"]
            put "!" into tPercent
         end if
      end repeat
      
      -- Set the data back to the grid
      set the dgData of group tGridName of tParentGroup to tDGData
      
      -- Update UI based on first row of THIS grid
      put tDGData[1]["ChannelLevel"] into tRaw
      
      if tRaw < 18 then
         if tGridIndex = 1 then
            set the icon of me to iconOff
         else
            set the label of me to "OFF"
         end if
      else
         if tGridIndex = 1 then
            set the icon of me to iconOn
         else
            put tDGData[1]["ChannelPercent"] into tPercent
            set the label of me to tPercent
         end if
      end if
   end repeat
end DMXGridComplete
